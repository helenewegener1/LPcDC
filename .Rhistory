seurat_obj <- seurat_obj_list[[sample_name]]
# Calculate QC metrics
seurat_obj[["percent.mt"]] <- PercentageFeatureSet(seurat_obj, pattern = "^mt-")
seurat_obj[["percent.ribo"]] <- PercentageFeatureSet(seurat_obj, pattern = "^Rps|^Rpl")
seurat_obj[["percent.hb"]] <- PercentageFeatureSet(seurat_obj, pattern = "^Hb[ab]")
# if large data set, subset cells for visualization purposes (it takes too long to plot all cells)
n_cells_raw <- ncol(seurat_obj)
# Plot QC metrics in violin plots
plot_qc(seurat_obj = seurat_obj,
sample_name = sample_name,
n_cells = n_cells_raw,
version = "raw",
filtering = "")
# Extra plots
FeatureScatter(seurat_obj, feature1 = "nCount_RNA", feature2 = "percent.mt")
FeatureScatter(seurat_obj, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
# Filter cells based on QC plots
filtering_expr <- expr(nFeature_RNA > 400 & nFeature_RNA < 4000 & percent.mt < 10)
seurat_obj_filtered <- subset(seurat_obj, subset = !!filtering_expr)
n_cells_filtered <- ncol(seurat_obj_filtered)
# Plot QC metrics in violin plots after filtering
plot_qc(seurat_obj = seurat_obj_filtered,
sample_name = sample_name,
n_cells = n_cells_filtered,
version = "filtered",
filtering = rlang::expr_text(filtering_expr))
# Save filtered seurat object
seurat_obj_QC_filtered_list[[sample_name]] <- seurat_obj_filtered
# Clean up
rm(seurat_obj, seurat_obj_filtered, n_cells_raw, n_cells_filtered)
########################################## Export list of filtered Seurat objects ##########################################
names(seurat_obj_QC_filtered_list)
setwd("~/Documents/projects/project_cDC/LPcDC/")
# Load libraries
library(SeuratObject)
library(Seurat)
library(dplyr)
library(glue)
library(ggplot2)
library(patchwork)
source("03_QC_filtering/script/functions.R")
# Load data
seurat_obj_list <- readRDS("02_QC/out/seurat_obj_QC_metrics.rds")
# Initialize filtered list
seurat_obj_QC_filtered_list <- list()
############################################ Data set 1. Caspar Ohnmacht ############################################
# Sample: GSM7789315 control SI-LP steady state
sample_name <- "GSM7789315"
seurat_obj <- seurat_obj_list[[sample_name]]
# Calculate QC metrics
seurat_obj[["percent.mt"]] <- PercentageFeatureSet(seurat_obj, pattern = "^mt-")
seurat_obj[["percent.ribo"]] <- PercentageFeatureSet(seurat_obj, pattern = "^Rps|^Rpl")
seurat_obj[["percent.hb"]] <- PercentageFeatureSet(seurat_obj, pattern = "^Hb[ab]")
# if large data set, subset cells for visualization purposes (it takes too long to plot all cells)
n_cells_raw <- ncol(seurat_obj)
# Real raw n_cells: 2156566
# subset to 5k cells
# subset_cells <- sample(colnames(seurat_obj), 5000)
# seurat_obj_subset <- seurat_obj[, subset_cells]
# Plot QC metrics in violin plots
plot_qc(seurat_obj = seurat_obj,
sample_name = sample_name,
n_cells = n_cells_raw,
version = "raw",
filtering = "")
# Extra plots
FeatureScatter(seurat_obj, feature1 = "nCount_RNA", feature2 = "percent.mt")
FeatureScatter(seurat_obj, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
# Filter cells based on QC plots
filtering_expr <- expr(nFeature_RNA > 1000 & nFeature_RNA < 6000 & percent.mt < 5)
seurat_obj_filtered <- subset(seurat_obj, subset = !!filtering_expr)
n_cells_filtered <- ncol(seurat_obj_filtered)
# Plot QC metrics in violin plots after filtering
plot_qc(seurat_obj = seurat_obj_filtered,
sample_name = sample_name,
n_cells = n_cells_filtered,
version = "filtered",
filtering = rlang::expr_text(filtering_expr))
# Save filtered seurat object
seurat_obj_QC_filtered_list[[sample_name]] <- seurat_obj_filtered
# Clean up
rm(seurat_obj, seurat_obj_filtered, n_cells_raw, n_cells_filtered)
############################################ Data set 2. Vuk Cerovic ############################################
# Sample: GSM8672515	Small intestinal dendritic cells CCR7gfp SI LP DCs
sample_name <- "GSM8672515"
seurat_obj <- seurat_obj_list[[sample_name]]
# Calculate QC metrics
seurat_obj[["percent.mt"]] <- PercentageFeatureSet(seurat_obj, pattern = "^mt-")
seurat_obj[["percent.ribo"]] <- PercentageFeatureSet(seurat_obj, pattern = "^Rps|^Rpl")
# if large data set, subset cells for visualization purposes (it takes too long to plot all cells)
n_cells_raw <- ncol(seurat_obj) # 1963
# Plot QC metrics in violin plots
plot_qc(seurat_obj = seurat_obj,
sample_name = sample_name,
n_cells = n_cells_raw,
version = "raw",
filtering = "")
# Filter cells based on QC plots
filtering_expr <- expr(nFeature_RNA < 6000 & nFeature_RNA > 400 & percent.mt < 4)
seurat_obj_filtered <- subset(seurat_obj, subset = !!filtering_expr)
n_cells_filtered <- ncol(seurat_obj_filtered)
# Plot QC metrics in violin plots after filtering
plot_qc(seurat_obj = seurat_obj_filtered,
sample_name = sample_name,
n_cells = n_cells_filtered,
version = "filtered",
filtering = rlang::expr_text(filtering_expr))
# Save filtered seurat object
seurat_obj_QC_filtered_list[[sample_name]] <- seurat_obj_filtered
# Clean up
rm(seurat_obj, seurat_obj_filtered, n_cells_raw, n_cells_filtered)
##### ##### ##### ##### ##### ##### ##### ##### ##### ##### ##### ##### ##### #####
# Sample: GSM9122899	Small intestinal dendritic cells from WT mice
sample_name <- "GSM9122899"
seurat_obj <- seurat_obj_list[[sample_name]]
# Calculate QC metrics
seurat_obj[["percent.mt"]] <- PercentageFeatureSet(seurat_obj, pattern = "^mt-")
seurat_obj[["percent.ribo"]] <- PercentageFeatureSet(seurat_obj, pattern = "^Rps|^Rpl")
# if large data set, subset cells for visualization purposes (it takes too long to plot all cells)
n_cells_raw <- ncol(seurat_obj) # 11414
# Plot QC metrics in violin plots
plot_qc(seurat_obj = seurat_obj,
sample_name = sample_name,
n_cells = n_cells_raw,
version = "raw",
filtering = "")
# Filter cells based on QC plots
filtering_expr <- expr(nFeature_RNA < 6000 & nFeature_RNA > 400 & percent.mt < 2.5)
seurat_obj_filtered <- subset(seurat_obj, subset = !!filtering_expr)
n_cells_filtered <- ncol(seurat_obj_filtered)
# Plot QC metrics in violin plots after filtering
plot_qc(seurat_obj = seurat_obj_filtered,
sample_name = sample_name,
n_cells = n_cells_filtered,
version = "filtered",
filtering = rlang::expr_text(filtering_expr))
# Save filtered seurat object
seurat_obj_QC_filtered_list[[sample_name]] <- seurat_obj_filtered
# Clean up
rm(seurat_obj, seurat_obj_filtered, n_cells_raw, n_cells_filtered)
############################################ Data set 3. Vuk Cerovic ############################################
# THIS IS BULK DATA!
############################################ Data set 4. George Kollias ############################################
# GSE255350_myeloid_raw_counts.txt.gz
sample_name <- "GSE255350"
seurat_obj <- seurat_obj_list[[sample_name]]
# Calculate QC metrics
seurat_obj[["percent.mt"]] <- PercentageFeatureSet(seurat_obj, pattern = "^mt-")
seurat_obj[["percent.ribo"]] <- PercentageFeatureSet(seurat_obj, pattern = "^Rps|^Rpl")
# if large data set, subset cells for visualization purposes (it takes too long to plot all cells)
n_cells_raw <- ncol(seurat_obj) # 2228
# Plot QC metrics in violin plots
plot_qc(seurat_obj = seurat_obj,
sample_name = sample_name,
n_cells = n_cells_raw,
version = "raw",
filtering = "")
# Filter cells based on QC plots
filtering_expr <- expr(nFeature_RNA < 6000 & nFeature_RNA > 2000 & percent.mt < 3.5)
seurat_obj_filtered <- subset(seurat_obj, subset = !!filtering_expr)
n_cells_filtered <- ncol(seurat_obj_filtered)
# Plot QC metrics in violin plots after filtering
plot_qc(seurat_obj = seurat_obj_filtered,
sample_name = sample_name,
n_cells = n_cells_filtered,
version = "filtered",
filtering = rlang::expr_text(filtering_expr))
# Save filtered seurat object
seurat_obj_QC_filtered_list[[sample_name]] <- seurat_obj_filtered
# Clean up
rm(seurat_obj, seurat_obj_filtered, n_cells_raw, n_cells_filtered)
############################################ Data set 5. Fiona Powrie ############################################
# sample_name <- "CRAM1"
#
# seurat_obj <- seurat_obj_list[[sample_name]]
#
# # Calculate QC metrics
# seurat_obj[["percent.mt"]] <- PercentageFeatureSet(seurat_obj, pattern = "^mt-")
# seurat_obj[["percent.ribo"]] <- PercentageFeatureSet(seurat_obj, pattern = "^Rps|^Rpl")
#
# # if large data set, subset cells for visualization purposes (it takes too long to plot all cells)
# n_cells_raw <- ncol(seurat_obj) # 224334
#
# # # Real raw n_cells: 224334
# # # subset to 5k cells
# # subset_cells <- sample(colnames(seurat_obj), 5000)
# # seurat_obj_subset <- seurat_obj[, subset_cells]
#
# # Plot QC metrics in violin plots
# plot_qc(seurat_obj = seurat_obj,
#         sample_name = sample_name,
#         n_cells = n_cells_raw,
#         version = "pre_filtered",
#         filtering = "")
#
# # # Filter cells based on QC plots
# # filtering_expr <- expr(nFeature_RNA < 2500 & nFeature_RNA > 400 & percent.mt < 2.5)
# # seurat_obj_filtered <- subset(seurat_obj, subset = !!filtering_expr)
# #
# # n_cells_filtered <- ncol(seurat_obj_filtered)
# #
# # # Plot QC metrics in violin plots after filtering
# # plot_qc(seurat_obj = seurat_obj_filtered,
# #         sample_name = sample_name,
# #         n_cells = n_cells_filtered,
# #         version = "filtered",
# #         filtering = rlang::expr_text(filtering_expr))
#
# # Save filtered seurat object
# seurat_obj_QC_filtered_list[[sample_name]] <- seurat_obj
#
# # Clean up
# rm(seurat_obj, n_cells_raw)
#
# ### ### ### ### ### ### ### ### ### ### ### ### ### ### ### ### ### ### ### ###
#
# sample_name <- "CRAM2"
#
# seurat_obj <- seurat_obj_list[[sample_name]]
#
# # Calculate QC metrics
# seurat_obj[["percent.mt"]] <- PercentageFeatureSet(seurat_obj, pattern = "^mt-")
# seurat_obj[["percent.ribo"]] <- PercentageFeatureSet(seurat_obj, pattern = "^Rps|^Rpl")
#
# # if large data set, subset cells for visualization purposes (it takes too long to plot all cells)
# n_cells_raw <- ncol(seurat_obj) # 281591
#
# # Real raw n_cells: 281591
# # subset to 5k cells
# # subset_cells <- sample(colnames(seurat_obj), 5000)
# # seurat_obj_subset <- seurat_obj[, subset_cells]
#
# # Plot QC metrics in violin plots
# plot_qc(seurat_obj = seurat_obj,
#         sample_name = sample_name,
#         n_cells = n_cells_raw,
#         version = "pre_filtered",
#         filtering = "")
#
# # # Filter cells based on QC plots
# # filtering_expr <- expr(nFeature_RNA < 2500 & nFeature_RNA > 400 & percent.mt < 2.5)
# # seurat_obj_filtered <- subset(seurat_obj, subset = !!filtering_expr)
# #
# # n_cells_filtered <- ncol(seurat_obj_filtered)
# #
# # # Plot QC metrics in violin plots after filtering
# # plot_qc(seurat_obj = seurat_obj_filtered,
# #         sample_name = sample_name,
# #         n_cells = n_cells_filtered,
# #         version = "filtered",
# #         filtering = rlang::expr_text(filtering_expr))
#
# # Save filtered seurat object
# seurat_obj_QC_filtered_list[[sample_name]] <- seurat_obj
#
# # Clean up
# rm(seurat_obj, n_cells_raw)
############################################ Data set 6. Rivera CA ############################################
# Sample: GSM5678427 CD103+CD11b+ dendritic cells from lamina propria
sample_name <- "GSM5678427"
seurat_obj <- seurat_obj_list[[sample_name]]
# Calculate QC metrics
seurat_obj[["percent.mt"]] <- PercentageFeatureSet(seurat_obj, pattern = "^mt-")
seurat_obj[["percent.ribo"]] <- PercentageFeatureSet(seurat_obj, pattern = "^Rps|^Rpl")
seurat_obj[["percent.hb"]] <- PercentageFeatureSet(seurat_obj, pattern = "^Hb[ab]")
# if large data set, subset cells for visualization purposes (it takes too long to plot all cells)
n_cells_raw <- ncol(seurat_obj)
# Plot QC metrics in violin plots
plot_qc(seurat_obj = seurat_obj,
sample_name = sample_name,
n_cells = n_cells_raw,
version = "raw",
filtering = "")
# Extra plots
FeatureScatter(seurat_obj, feature1 = "nCount_RNA", feature2 = "percent.mt")
FeatureScatter(seurat_obj, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
# Filter cells based on QC plots
filtering_expr <- expr(nFeature_RNA > 400 & nFeature_RNA < 4000 & percent.mt < 10)
seurat_obj_filtered <- subset(seurat_obj, subset = !!filtering_expr)
n_cells_filtered <- ncol(seurat_obj_filtered)
# Plot QC metrics in violin plots after filtering
plot_qc(seurat_obj = seurat_obj_filtered,
sample_name = sample_name,
n_cells = n_cells_filtered,
version = "filtered",
filtering = rlang::expr_text(filtering_expr))
# Save filtered seurat object
seurat_obj_QC_filtered_list[[sample_name]] <- seurat_obj_filtered
# Clean up
rm(seurat_obj, seurat_obj_filtered, n_cells_raw, n_cells_filtered)
########################################## Export list of filtered Seurat objects ##########################################
names(seurat_obj_QC_filtered_list)
saveRDS(seurat_obj_QC_filtered_list, "03_QC_filtering/out/seurat_obj_QC_filtered_list.rds")
setwd("~/Documents/projects/project_cDC/LPcDC/")
# Load libraries
library(SeuratObject)
library(Seurat)
library(glmGamPoi)
library(dplyr)
library(stringr)
library(glue)
library(ggplot2)
library(harmony)
# remotes::install_github('satijalab/seurat-wrappers')
library(SeuratWrappers)
# remotes::install_github('satijalab/azimuth', ref = 'master')
library(Azimuth)
library(clustree)
# Load data
seurat_obj_list <- readRDS("03_QC_filtering/out/seurat_obj_QC_filtered_list.rds")
############################ RNA integration prep ############################
# Merge
seurat_merged <- merge(seurat_obj_list[[1]], y = seurat_obj_list[-1])
Layers(seurat_merged[["RNA"]]) # already split
DefaultAssay(seurat_merged) <- "RNA"
# Seurat workflow
seurat_merged <- NormalizeData(seurat_merged)
seurat_merged <- FindVariableFeatures(seurat_merged)
seurat_merged <- ScaleData(seurat_merged)
seurat_merged <- RunPCA(seurat_merged)
ElbowPlot(seurat_merged)
seurat_merged <- FindNeighbors(seurat_merged,  dims = 1:30)
seurat_merged <- FindClusters(seurat_merged, resolution = 0.4)
seurat_merged <- RunUMAP(seurat_merged, reduction = "pca", dims = 1:30)
# Save merged object
# saveRDS(seurat_merged, "04_integration/out/seurat_merged_SCT.rds")
# seurat_merged <- readRDS("04_integration/out/seurat_merged_SCT.rds")
DefaultAssay(seurat_merged)
# Visualize with UMAP stratified by dataset - pre integration
DimPlot(seurat_merged, reduction = "umap", group.by = "orig.ident") +
labs(title = "UMAP - RNA - pre integration") +
theme(legend.text = element_text(size = 8))
ggsave("04_integration/plot/RNA/UMAP_RNA_pre_integration_orig.ident.pdf",
width = 8,
height = 7)
DefaultAssay(seurat_merged)
############################## Integration on RNA ##############################
seurat_integrated <- seurat_merged
DefaultAssay(seurat_integrated) <- "RNA"
Layers(seurat_integrated[["RNA"]])
# seurat_integrated <- seurat_merged
#
# DefaultAssay(seurat_integrated) <- "SCT"
#
# Layers(seurat_integrated[["SCT"]])
#
# Reductions(seurat_integrated)
seurat_integrated <- IntegrateLayers(
object = seurat_integrated,
method = CCAIntegration,
orig.reduction = "pca",
new.reduction = "RNA_integrated.cca",
assay = "RNA",
verbose = FALSE
)
seurat_integrated <- IntegrateLayers(
object = seurat_integrated,
method = HarmonyIntegration,
orig.reduction = "pca",
new.reduction = "RNA_integrated.harmony",
assay = "RNA",
verbose = FALSE
)
options(future.globals.maxSize = 8000 * 1024^2)  # 8 GB
seurat_integrated <- IntegrateLayers(
object = seurat_integrated,
method = RPCAIntegration,
orig.reduction = "pca",
new.reduction = "RNA_integrated.rpca",
assay = "RNA",
verbose = FALSE
)
seurat_integrated <- IntegrateLayers(
object = seurat_integrated,
method = FastMNNIntegration,
orig.reduction = "pca",
new.reduction = "RNA_integrated.mnn",
assay = "RNA",
verbose = FALSE
)
################### Export list of integrated Seurat objects ###################
Reductions(seurat_integrated)
####################### Run UMAP using Harmony embedding #######################
reductions <- list(
c("RNA_integrated.cca", "RNA_umap.cca", "RNA_cca_clusters")
# c("RNA_integrated.harmony", "RNA_umap.harmony", "RNA_harmony_clusters"),
# c("RNA_integrated.mnn", "RNA_umap.mnn", "RNA_mnn_clusters"),
# c("RNA_integrated.rpca", "RNA_umap.rpca", "RNA_rpca_clusters")
)
# red <- c("RNA_integrated.cca", "RNA_umap.cca", "RNA_cca_clusters")
for (red in reductions){
reduction <- red[[1]]
umap_reduction.name <- red[[2]]
cluster.name <- red[[3]]
# Either RNA or SCT
assay <- str_split_i(reduction, "_", 1)
# Set default assay
DefaultAssay(seurat_integrated) <- assay
seurat_integrated <- FindNeighbors(seurat_integrated, reduction = reduction, dims = 1:20)
seurat_integrated <- FindClusters(seurat_integrated, resolution = 2, cluster.name = cluster.name)
seurat_integrated <- RunUMAP(seurat_integrated, reduction = reduction, dims = 1:20, reduction.name = umap_reduction.name)
seurat_integrated <- FindNeighbors(seurat_integrated, reduction = reduction, dims = 1:20)
# Visualize with UMAP stratified by dataset - post harmony integration
DimPlot(seurat_integrated, reduction = umap_reduction.name, group.by = "orig.ident") +
labs(title = glue("UMAP - post {reduction}")) +
theme(legend.text = element_text(size = 8))
ggsave(glue("04_integration/plot/{assay}/UMAP_{reduction}_orig.ident.pdf"),
width = 8,
height = 7)
DimPlot(seurat_integrated, reduction = umap_reduction.name, split.by = "orig.ident", ncol = 3) +
labs(title = glue("UMAP - post {reduction}")) +
theme(legend.text = element_text(size = 8))
ggsave(glue("04_integration/plot/{assay}/UMAP_{reduction}_orig.ident_split.pdf"),
width = 12,
height = 8)
# Visualize with UMAP stratified by seurat clusters - post harmony integration
res_list <- c(0.05, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7)
for (res in res_list){
# res <- 0.3
seurat_integrated <- FindClusters(seurat_integrated, resolution = res, cluster.name = glue("{cluster.name}_res.{res}"))
# WHAT TO NAME THEM?
DimPlot(seurat_integrated, reduction = umap_reduction.name, group.by = glue("{cluster.name}_res.{res}"), label = TRUE) +
labs(title = glue("UMAP - post {reduction}"),
subtitle = glue("{cluster.name}_res.{res}"))
ggsave(glue(glue("04_integration/plot/{assay}/UMAP_{reduction}_{assay}_snn_res_{res}.pdf")),
width = 8,
height = 7)
DimPlot(seurat_integrated, reduction = umap_reduction.name, group.by = glue("{cluster.name}_res.{res}"), split.by = "orig.ident", ncol = 3) +
labs(title = glue("UMAP - post {reduction}"),
subtitle = glue("{cluster.name}_res.{res}"))
ggsave(glue("04_integration/plot/{assay}/UMAP_{reduction}_{assay}_snn_res_{res}_split.by_orig.ident.pdf"),
width = 12,
height = 8)
}
# Feature plots: UMAP stratified by continuous variable
# features <- c("nFeature_RNA", "percent.mt", "percent.ribo")
#
# lapply(features, function(x) {
#
#   FeaturePlot(seurat_integrated, reduction = umap_reduction.name, features = x)
#   ggsave(glue("04_integration/plot/{assay}/UMAP_{reduction}_{x}.pdf"),
#          width = 8,
#          height = 7)
#
# })
}
# clustree
cluster.name <- "RNA_cca_clusters"
pdf(file = glue("04_integration/plot/{assay}/clustree_{cluster.name}.pdf"), width = 12, height = 10)
clustree(seurat_integrated, assay = "RNA", return = "plot", prefix = glue("{cluster.name}_res."))
dev.off()
cluster.name <- "RNA_harmony_clusters"
pdf(file = glue("04_integration/plot/{assay}/clustree_{cluster.name}.pdf"), width = 12, height = 10)
clustree(seurat_integrated, assay = "RNA", return = "plot", prefix = glue("{cluster.name}_res."))
DefaultAssay(seurat_merged)
cluster.name <- "RNA_cca_clusters"
clustree(seurat_integrated, assay = "RNA", return = "plot", prefix = glue("{cluster.name}_res."))
pdf(file = glue("04_integration/plot/{assay}/clustree_{cluster.name}.pdf"), width = 12, height = 10)
clustree(seurat_integrated, assay = "RNA", return = "plot", prefix = glue("{cluster.name}_res."))
dev.off()
Reductions(seurat_integrated)
saveRDS(seurat_integrated, "04_integration/out/seurat_integrated_v5_RNA.rds")
library(SeuratDisk)
library(rhdf5)
# All in one file
obj_tmp <- seurat_integrated
DefaultAssay(obj_tmp)
Layers(obj_tmp[["RNA"]])
# IMPORTANT: Join layers before export (h5ad doesn't support split layers)
obj_tmp[["RNA"]] <- JoinLayers(obj_tmp[["RNA"]])
obj_tmp[["RNA3"]] <- as(object = obj_tmp[["RNA"]], Class = "Assay")
DefaultAssay(obj_tmp) <- "RNA3"
obj_tmp[["RNA"]] <- NULL
obj_tmp <- RenameAssays(object = obj_tmp, RNA3 = 'RNA')
# Check new names
reductions <- Reductions(obj_tmp)[str_detect(Reductions(obj_tmp), "integrated")]
# 1. Extract the embeddings
embeddings <- lapply(reductions, function(x) Embeddings(obj_tmp, reduction = x))
names(embeddings) <- reductions
# 2. Add the clean matrix as a new reduction
for(x in reductions) {
new_name <- str_replace(x, "\\.", "_")
new_key <- str_replace(x, "_integrated\\.", "") %>%
str_to_upper() %>%
paste0("_")
obj_tmp[[new_name]] <- CreateDimReducObject(
embeddings = embeddings[[x]],
key = new_key,
assay = DefaultAssay(obj_tmp),
global = TRUE
)
# Remove the problematic reduction to keep things clean
obj_tmp[[x]] <- NULL
}
# Handle PCA
obj_tmp[["PCA"]] <- CreateDimReducObject(
embeddings = Embeddings(obj_tmp, reduction = "pca"),
key = "PCA_",
assay = DefaultAssay(obj_tmp),
global = TRUE
)
# Remove the problematic reduction to keep things clean
obj_tmp[["pca"]] <- NULL
umap_reductions <- Reductions(obj_tmp)[str_detect(Reductions(obj_tmp), "umap")]
for (x in umap_reductions) {
obj_tmp[[x]] <- NULL
}
# Verify the new reduction name (optional)
Reductions(obj_tmp)
filename <- glue("04_integration/out/mydata_RNA_v5.h5Seurat")
SaveH5Seurat(obj_tmp, filename = filename, overwrite = TRUE)
Convert(filename, dest = "h5ad", overwrite = TRUE, verbose = FALSE)
